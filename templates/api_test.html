{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>API Testing Interface</h2>
    
    <!-- Vehicle Presence API -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Vehicle Presence API</h5>
        </div>
        <div class="card-body">
            <form id="presenceForm" class="mb-3">
                <div class="mb-3">
                    <label class="form-label">Lane ID</label>
                    <input type="number" class="form-control" name="lane_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Device ID</label>
                    <input type="number" class="form-control" name="device_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Confidence</label>
                    <input type="number" class="form-control" name="confidence" step="0.01" required>
                </div>
                <button type="submit" class="btn btn-primary">Test Vehicle Presence</button>
            </form>
            <div class="response-container">
                <h6>Response:</h6>
                <div class="response-output"></div>
            </div>
        </div>
    </div>

    <!-- ANPR API -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ANPR API</h5>
        </div>
        <div class="card-body">
            <form id="anprForm" class="mb-3">
                <div class="mb-3">
                    <label class="form-label">Lane ID</label>
                    <input type="number" class="form-control" name="lane_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Device ID</label>
                    <input type="number" class="form-control" name="device_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Vehicle Number</label>
                    <input type="text" class="form-control" name="vehicle_number" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Confidence</label>
                    <input type="number" class="form-control" name="confidence" step="0.01" required>
                </div>
                <button type="submit" class="btn btn-primary">Test ANPR</button>
            </form>
            <div class="response-container">
                <h6>Response:</h6>
                <div class="response-output"></div>
            </div>
        </div>
    </div>

    <!-- Barrier Control API -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Barrier Control API</h5>
        </div>
        <div class="card-body">
            <form id="barrierForm" class="mb-3">
                <div class="mb-3">
                    <label class="form-label">Lane ID</label>
                    <input type="number" class="form-control" name="lane_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Device ID</label>
                    <input type="number" class="form-control" name="device_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Action</label>
                    <select class="form-control" name="action" required>
                        <option value="open">Open</option>
                        <option value="close">Close</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Test Barrier Control</button>
            </form>
            <div class="response-container">
                <h6>Response:</h6>
                <div class="response-output"></div>
            </div>
        </div>
    </div>

    <!-- Health Check API -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Health Check API</h5>
        </div>
        <div class="card-body">
            <form id="healthForm" class="mb-3">
                <div class="mb-3">
                    <label class="form-label">Lane ID</label>
                    <input type="number" class="form-control" name="lane_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Device ID</label>
                    <input type="number" class="form-control" name="device_id" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Device Type</label>
                    <select class="form-control" name="device_type" required>
                        <option value="sensor">Sensor</option>
                        <option value="camera">Camera</option>
                        <option value="barrier">Barrier</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-control" name="status" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Test Health Check</button>
            </form>
            <div class="response-container">
                <h6>Response:</h6>
                <div class="response-output"></div>
            </div>
        </div>
    </div>
</div>

<style>
.response-container {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-top: 10px;
    border: 1px solid #dee2e6;
}

.response-output {
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 0;
    font-family: monospace;
    font-size: 14px;
    line-height: 1.5;
}

.response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #dee2e6;
}

.response-timestamp {
    font-size: 12px;
    color: #6c757d;
}

.response-status {
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
}

.status-success {
    background-color: #d4edda;
    color: #155724;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 5px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to handle API responses
    function handleResponse(formId, response, status = 'success') {
        const output = document.querySelector(`#${formId} .response-output`);
        const timestamp = new Date().toLocaleString();
        
        let responseHtml = `
            <div class="response-header">
                <span class="response-timestamp">${timestamp}</span>
                <span class="response-status status-${status}">
                    ${status === 'pending' ? '<span class="loading-spinner"></span>' : ''}
                    ${status.toUpperCase()}
                </span>
            </div>
            <pre>${JSON.stringify(response, null, 2)}</pre>
        `;
        
        if (status === 'pending') {
            output.innerHTML = responseHtml;
        } else {
            output.innerHTML = responseHtml + output.innerHTML;
        }
    }

    // Helper function to handle API errors
    function handleError(formId, error) {
        const errorMessage = error.message || 'An unknown error occurred';
        handleResponse(formId, { error: errorMessage }, 'error');
    }

    // Vehicle Presence API
    document.getElementById('presenceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            confidence: parseFloat(formData.get('confidence')),
            timestamp: new Date().toISOString()
        };

        handleResponse('presenceForm', { request: data }, 'pending');

        fetch('/api/vehicle/presence', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('presenceForm', data, 'success'))
        .catch(error => handleError('presenceForm', error));
    });

    // ANPR API
    document.getElementById('anprForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            vehicle_number: formData.get('vehicle_number'),
            confidence: parseFloat(formData.get('confidence')),
            timestamp: new Date().toISOString()
        };

        handleResponse('anprForm', { request: data }, 'pending');

        fetch('/api/vehicle/anpr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('anprForm', data, 'success'))
        .catch(error => handleError('anprForm', error));
    });

    // Barrier Control API
    document.getElementById('barrierForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            action: formData.get('action'),
            timestamp: new Date().toISOString()
        };

        handleResponse('barrierForm', { request: data }, 'pending');

        fetch('/api/barrier/control', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('barrierForm', data, 'success'))
        .catch(error => handleError('barrierForm', error));
    });

    // Health Check API
    document.getElementById('healthForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            device_type: formData.get('device_type'),
            status: formData.get('status'),
            last_heartbeat: new Date().toISOString()
        };

        handleResponse('healthForm', { request: data }, 'pending');

        fetch('/api/health/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('healthForm', data, 'success'))
        .catch(error => handleError('healthForm', error));
    });
});
</script>
{% endblock %} 