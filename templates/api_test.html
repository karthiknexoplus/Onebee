{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">API Testing Interface</h2>
    
    <!-- Vehicle Presence API -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Vehicle Presence API</h5>
        </div>
        <div class="card-body">
            <form id="presenceForm" class="mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Lane ID</label>
                            <input type="number" class="form-control" name="lane_id" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Device ID</label>
                            <input type="number" class="form-control" name="device_id" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Confidence</label>
                            <input type="number" class="form-control" name="confidence" step="0.01" required>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>Test Vehicle Presence
                </button>
            </form>
            <div class="progress mb-3 d-none">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <div class="response-container">
                <div class="response-output"></div>
            </div>
        </div>
    </div>

    <!-- ANPR API -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">ANPR API</h5>
        </div>
        <div class="card-body">
            <form id="anprForm" class="mb-3">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Lane ID</label>
                            <input type="number" class="form-control" name="lane_id" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Device ID</label>
                            <input type="number" class="form-control" name="device_id" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Vehicle Number</label>
                            <input type="text" class="form-control" name="vehicle_number" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Confidence</label>
                            <input type="number" class="form-control" name="confidence" step="0.01" required>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-camera me-2"></i>Test ANPR
                </button>
            </form>
            <div class="progress mb-3 d-none">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <div class="response-container">
                <div class="response-output"></div>
            </div>
        </div>
    </div>

    <!-- Barrier Control API -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Barrier Control API</h5>
        </div>
        <div class="card-body">
            <form id="barrierForm" class="mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Lane ID</label>
                            <input type="number" class="form-control" name="lane_id" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Device ID</label>
                            <input type="number" class="form-control" name="device_id" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Action</label>
                            <select class="form-control" name="action" required>
                                <option value="open">Open</option>
                                <option value="close">Close</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-door-open me-2"></i>Test Barrier Control
                </button>
            </form>
            <div class="progress mb-3 d-none">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <div class="response-container">
                <div class="response-output"></div>
            </div>
        </div>
    </div>

    <!-- Health Check API -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Health Check API</h5>
        </div>
        <div class="card-body">
            <form id="healthForm" class="mb-3">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Lane ID</label>
                            <input type="number" class="form-control" name="lane_id" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Device ID</label>
                            <input type="number" class="form-control" name="device_id" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Device Type</label>
                            <select class="form-control" name="device_type" required>
                                <option value="sensor">Sensor</option>
                                <option value="camera">Camera</option>
                                <option value="barrier">Barrier</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-info text-white">
                    <i class="fas fa-heartbeat me-2"></i>Test Health Check
                </button>
            </form>
            <div class="progress mb-3 d-none">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <div class="response-container">
                <div class="response-output"></div>
            </div>
        </div>
    </div>
</div>

<style>
.response-container {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-top: 10px;
    border: 1px solid #dee2e6;
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
}

.response-output {
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 0;
    font-family: 'Fira Code', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #dee2e6;
}

.response-timestamp {
    font-size: 12px;
    color: #6c757d;
}

.response-status {
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
}

.status-success {
    background-color: #d4edda;
    color: #155724;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 5px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.btn {
    transition: all 0.2s;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
    border-color: #86b7fe;
}

/* Custom scrollbar for response container */
.response-container::-webkit-scrollbar {
    width: 8px;
}

.response-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.response-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.response-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Response animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.response-item {
    animation: fadeIn 0.3s ease-out;
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 5px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Progress bar animation */
.progress {
    height: 4px;
    margin-bottom: 15px;
}

.progress-bar {
    transition: width 0.3s ease;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to handle API responses
    function handleResponse(formId, response, status = 'success') {
        const output = document.querySelector(`#${formId} .response-output`);
        const progress = document.querySelector(`#${formId} .progress`);
        const timestamp = new Date().toLocaleString();
        
        let responseHtml = `
            <div class="response-item">
                <div class="response-header">
                    <span class="response-timestamp">${timestamp}</span>
                    <span class="response-status status-${status}">
                        ${status === 'pending' ? '<span class="loading-spinner"></span>' : ''}
                        ${status.toUpperCase()}
                    </span>
                </div>
                <pre>${JSON.stringify(response, null, 2)}</pre>
            </div>
        `;
        
        if (status === 'pending') {
            progress.classList.remove('d-none');
            output.innerHTML = responseHtml;
        } else {
            progress.classList.add('d-none');
            output.innerHTML = responseHtml + output.innerHTML;
        }
    }

    // Helper function to handle API errors
    function handleError(formId, error) {
        const errorMessage = error.message || 'An unknown error occurred';
        handleResponse(formId, { error: errorMessage }, 'error');
    }

    // Vehicle Presence API
    document.getElementById('presenceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            confidence: parseFloat(formData.get('confidence')),
            timestamp: new Date().toISOString()
        };

        handleResponse('presenceForm', { request: data }, 'pending');

        fetch('/api/vehicle/presence', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('presenceForm', data, 'success'))
        .catch(error => handleError('presenceForm', error));
    });

    // ANPR API
    document.getElementById('anprForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            vehicle_number: formData.get('vehicle_number'),
            confidence: parseFloat(formData.get('confidence')),
            timestamp: new Date().toISOString()
        };

        handleResponse('anprForm', { request: data }, 'pending');

        fetch('/api/vehicle/anpr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('anprForm', data, 'success'))
        .catch(error => handleError('anprForm', error));
    });

    // Barrier Control API
    document.getElementById('barrierForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            action: formData.get('action'),
            timestamp: new Date().toISOString()
        };

        handleResponse('barrierForm', { request: data }, 'pending');

        fetch('/api/barrier/control', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('barrierForm', data, 'success'))
        .catch(error => handleError('barrierForm', error));
    });

    // Health Check API
    document.getElementById('healthForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            lane_id: parseInt(formData.get('lane_id')),
            device_id: parseInt(formData.get('device_id')),
            device_type: formData.get('device_type'),
            status: formData.get('status'),
            last_heartbeat: new Date().toISOString()
        };

        handleResponse('healthForm', { request: data }, 'pending');

        fetch('/api/health/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => handleResponse('healthForm', data, 'success'))
        .catch(error => handleError('healthForm', error));
    });
});
</script>
{% endblock %} 