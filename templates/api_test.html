{% extends "base.html" %}

{% block title %}API Test - Access Control{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">API Test Interface</h2>
        <div class="api-status">
            <span class="status-indicator active"></span>
            <span class="status-text">API Server Online</span>
        </div>
    </div>

    <div class="alert alert-info mb-4">
        <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>How to Use</h5>
        <p class="mb-0">Fill in the form fields with the required data and click the "Test" button to send the request. The response will be displayed in the response box below each form.</p>
    </div>

    <!-- Vehicle Presence API -->
    <div class="card mb-4 api-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-car me-2"></i>Vehicle Presence API
            </h5>
            <span class="badge bg-primary">POST /api/vehicle/presence</span>
        </div>
        <div class="card-body">
            <div class="alert alert-secondary mb-3">
                <h6 class="alert-heading">Example Data:</h6>
                <pre class="mb-0">{
    "lane_id": 1,
    "device_id": 101,
    "confidence": 95.5,
    "status": "active",
    "timestamp": "2024-04-16T15:30:00Z"
}</pre>
            </div>
            <form id="vehiclePresenceForm" class="api-form">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="laneId" name="lane_id" placeholder="Lane ID" value="1" required>
                            <label for="laneId">Lane ID</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="deviceId" name="device_id" placeholder="Device ID" value="101" required>
                            <label for="deviceId">Device ID</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="confidence" name="confidence" min="0" max="100" placeholder="Confidence" value="95.5" required>
                            <label for="confidence">Confidence</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <select class="form-select" id="status" name="status" required>
                                <option value="active" selected>Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            <label for="status">Status</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Test Vehicle Presence API
                    </button>
                </div>
            </form>
            <div class="response-container mt-3">
                <div class="response-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Response</h6>
                    <div class="response-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Ready</span>
                    </div>
                </div>
                <div class="response-box" id="vehiclePresenceResponse"></div>
            </div>
        </div>
    </div>

    <!-- ANPR API -->
    <div class="card mb-4 api-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-camera me-2"></i>ANPR API
            </h5>
            <span class="badge bg-primary">POST /api/vehicle/anpr</span>
        </div>
        <div class="card-body">
            <div class="alert alert-secondary mb-3">
                <h6 class="alert-heading">Example Data:</h6>
                <pre class="mb-0">{
    "lane_id": 1,
    "device_id": 102,
    "vehicle_number": "ABC123",
    "confidence": 98.2,
    "timestamp": "2024-04-16T15:30:00Z"
}</pre>
            </div>
            <form id="anprForm" class="api-form">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="anprLaneId" name="lane_id" placeholder="Lane ID" value="1" required>
                            <label for="anprLaneId">Lane ID</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="anprDeviceId" name="device_id" placeholder="Device ID" value="102" required>
                            <label for="anprDeviceId">Device ID</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="vehicleNumber" name="vehicle_number" placeholder="Vehicle Number" value="ABC123" required>
                            <label for="vehicleNumber">Vehicle Number</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="anprConfidence" name="confidence" min="0" max="100" placeholder="Confidence" value="98.2" required>
                            <label for="anprConfidence">Confidence</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Test ANPR API
                    </button>
                </div>
            </form>
            <div class="response-container mt-3">
                <div class="response-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Response</h6>
                    <div class="response-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Ready</span>
                    </div>
                </div>
                <div class="response-box" id="anprResponse"></div>
            </div>
        </div>
    </div>

    <!-- Barrier Control API -->
    <div class="card mb-4 api-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-door-open me-2"></i>Barrier Control API
            </h5>
            <span class="badge bg-primary">POST /api/barrier/control</span>
        </div>
        <div class="card-body">
            <div class="alert alert-secondary mb-3">
                <h6 class="alert-heading">Example Data:</h6>
                <pre class="mb-0">{
    "lane_id": 1,
    "device_id": 103,
    "action": "open",
    "timestamp": "2024-04-16T15:30:00Z"
}</pre>
            </div>
            <form id="barrierControlForm" class="api-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="barrierLaneId" name="lane_id" placeholder="Lane ID" value="1" required>
                            <label for="barrierLaneId">Lane ID</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="barrierDeviceId" name="device_id" placeholder="Device ID" value="103" required>
                            <label for="barrierDeviceId">Device ID</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-select" id="action" name="action" required>
                                <option value="open" selected>Open</option>
                                <option value="close">Close</option>
                            </select>
                            <label for="action">Action</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Test Barrier Control API
                    </button>
                </div>
            </form>
            <div class="response-container mt-3">
                <div class="response-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Response</h6>
                    <div class="response-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Ready</span>
                    </div>
                </div>
                <div class="response-box" id="barrierControlResponse"></div>
            </div>
        </div>
    </div>

    <!-- Health Check API -->
    <div class="card mb-4 api-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-heartbeat me-2"></i>Health Check API
            </h5>
            <span class="badge bg-primary">POST /api/health/check</span>
        </div>
        <div class="card-body">
            <div class="alert alert-secondary mb-3">
                <h6 class="alert-heading">Example Data:</h6>
                <pre class="mb-0">{
    "lane_id": 1,
    "device_id": 104,
    "device_type": "sensor",
    "status": "healthy",
    "last_heartbeat": "2024-04-16T15:30:00Z",
    "timestamp": "2024-04-16T15:30:00Z"
}</pre>
            </div>
            <form id="healthCheckForm" class="api-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="healthLaneId" name="lane_id" placeholder="Lane ID" value="1" required>
                            <label for="healthLaneId">Lane ID</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="healthDeviceId" name="device_id" placeholder="Device ID" value="104" required>
                            <label for="healthDeviceId">Device ID</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-select" id="healthStatus" name="status" required>
                                <option value="healthy" selected>Healthy</option>
                                <option value="unhealthy">Unhealthy</option>
                            </select>
                            <label for="healthStatus">Status</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Test Health Check API
                    </button>
                </div>
            </form>
            <div class="response-container mt-3">
                <div class="response-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Response</h6>
                    <div class="response-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Ready</span>
                    </div>
                </div>
                <div class="response-box" id="healthCheckResponse"></div>
            </div>
        </div>
    </div>

    <!-- Lane Device Counts API -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Lane Device Counts API</h5>
        </div>
        <div class="card-body">
            <p>Get counts of lanes and their associated devices</p>
            <button type="button" class="btn btn-primary" id="getLaneDeviceCounts">Get Lane Device Counts</button>
            <div class="mt-3">
                <h6>Response:</h6>
                <div class="response-box" id="laneDeviceCountsResponse"></div>
            </div>
        </div>
    </div>

    <!-- User Management API -->
    <div class="card mb-4 api-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-users me-2"></i>User Management API
            </h5>
            <div>
                <span class="badge bg-primary">POST /api/users</span>
                <span class="badge bg-success">PUT /api/users/{id}</span>
            </div>
        </div>
        <div class="card-body">
            <!-- Add User Section -->
            <div class="mb-4">
                <h6 class="mb-3">Add User</h6>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="userName" value="John Doe">
                            <label for="userName">Name</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="userDesignation" value="Employee">
                            <label for="userDesignation">Designation</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="vehicleNumber" value="KA 01 AB 1234">
                            <label for="vehicleNumber">Vehicle Number</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="fastagId" value="FASTAG123456">
                            <label for="fastagId">Fastag ID</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="locationId" value="1">
                            <label for="locationId">Location ID</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="kycType" value="Aadhar">
                            <label for="kycType">KYC Document Type</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="kycNumber" value="123456789012">
                            <label for="kycNumber">KYC Document Number</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="isActive">
                                <option value="true" selected>Active</option>
                                <option value="false">Inactive</option>
                            </select>
                            <label for="isActive">Status</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control" id="validFrom" value="2024-04-01">
                            <label for="validFrom">Valid From</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control" id="validTo" value="2025-03-31">
                            <label for="validTo">Valid To</label>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Access Permissions</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="number" class="form-control" id="permissionLaneId" value="1">
                                <label for="permissionLaneId">Lane ID</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="time" class="form-control" id="startTime" value="09:00">
                                <label for="startTime">Start Time</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="time" class="form-control" id="endTime" value="18:00">
                                <label for="endTime">End Time</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="daysOfWeek" value="1,2,3,4,5">
                                <label for="daysOfWeek">Days of Week (1-7)</label>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="testAddUser()">
                    <i class="fas fa-plus me-2"></i>Test Add User
                </button>
                <div class="response-box mt-3">
                    <h6>Response:</h6>
                    <div class="json-box" id="addUserResponse"></div>
                </div>
            </div>

            <!-- Edit User Section -->
            <div class="mt-4">
                <h6 class="mb-3">Edit User</h6>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="editUserId" value="1">
                            <label for="editUserId">User ID to Edit</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="editUserName" value="John Doe Updated">
                            <label for="editUserName">Name</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="editUserDesignation" value="Senior Employee">
                            <label for="editUserDesignation">Designation</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="editVehicleNumber" value="KA 01 AB 1234">
                            <label for="editVehicleNumber">Vehicle Number</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="editLocationId" value="1">
                            <label for="editLocationId">Location ID</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="editIsActive">
                                <option value="true" selected>Active</option>
                                <option value="false">Inactive</option>
                            </select>
                            <label for="editIsActive">Status</label>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="testEditUser()">
                    <i class="fas fa-edit me-2"></i>Test Edit User
                </button>
                <div class="response-box mt-3">
                    <h6>Response:</h6>
                    <div class="json-box" id="editUserResponse"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.api-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease-in-out;
}

.api-card:hover {
    transform: translateY(-2px);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding: 1rem 1.5rem;
}

.form-floating {
    margin-bottom: 0;
}

.form-floating > .form-control,
.form-floating > .form-select {
    height: calc(3.5rem + 2px);
    line-height: 1.25;
}

.form-floating > label {
    padding: 1rem 0.75rem;
}

.response-container {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
}

.response-header {
    margin-bottom: 0.5rem;
}

.response-box {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 1rem;
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Fira Code', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
    white-space: pre-wrap;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
    background-color: #6c757d;
}

.status-indicator.active {
    background-color: #28a745;
}

.status-indicator.pending {
    background-color: #ffc107;
    animation: pulse 1.5s infinite;
}

.status-indicator.error {
    background-color: #dc3545;
}

.status-text {
    font-size: 0.875rem;
    color: #6c757d;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.btn-primary {
    padding: 0.5rem 1.5rem;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
    border-radius: 4px;
}

.alert-secondary pre {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin: 0;
    font-family: 'Fira Code', monospace;
    font-size: 0.9rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to update response status
    function updateResponseStatus(element, status) {
        const indicator = element.querySelector('.status-indicator');
        const text = element.querySelector('.status-text');
        
        indicator.className = 'status-indicator';
        text.textContent = status;
        
        switch(status) {
            case 'Pending':
                indicator.classList.add('pending');
                break;
            case 'Success':
                indicator.classList.add('active');
                break;
            case 'Error':
                indicator.classList.add('error');
                break;
            default:
                indicator.classList.add('active');
        }
    }

    // Helper function to handle API requests
    async function handleApiRequest(form, endpoint, responseElement) {
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'lane_id' || key === 'device_id') {
                data[key] = parseInt(value);
            } else if (key === 'confidence') {
                data[key] = parseFloat(value);
            } else {
                data[key] = value;
            }
        });
        data.timestamp = new Date().toISOString();

        if (endpoint.includes('health')) {
            data.device_type = 'sensor';
            data.last_heartbeat = new Date().toISOString();
        }

        const statusElement = responseElement.parentElement.querySelector('.response-status');
        updateResponseStatus(statusElement, 'Pending');

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            responseElement.textContent = JSON.stringify(result, null, 2);
            updateResponseStatus(statusElement, 'Success');
        } catch (error) {
            responseElement.textContent = 'Error: ' + error.message;
            updateResponseStatus(statusElement, 'Error');
        }
    }

    // Vehicle Presence API
    document.getElementById('vehiclePresenceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleApiRequest(
            this,
            '/api/vehicle/presence',
            document.getElementById('vehiclePresenceResponse')
        );
    });

    // ANPR API
    document.getElementById('anprForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleApiRequest(
            this,
            '/api/vehicle/anpr',
            document.getElementById('anprResponse')
        );
    });

    // Barrier Control API
    document.getElementById('barrierControlForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleApiRequest(
            this,
            '/api/barrier/control',
            document.getElementById('barrierControlResponse')
        );
    });

    // Health Check API
    document.getElementById('healthCheckForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleApiRequest(
            this,
            '/api/health/check',
            document.getElementById('healthCheckResponse')
        );
    });

    // Lane Device Counts API
    document.getElementById('getLaneDeviceCounts').addEventListener('click', async function() {
        const responseBox = document.getElementById('laneDeviceCountsResponse');
        responseBox.textContent = 'Loading...';
        
        try {
            const response = await fetch('/api/lane-device-counts');
            const data = await response.json();
            responseBox.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
            responseBox.textContent = `Error: ${error.message}`;
        }
    });
});

function testAddUser() {
    const data = {
        name: document.getElementById('userName').value,
        designation: document.getElementById('userDesignation').value,
        vehicle_number: document.getElementById('vehicleNumber').value,
        fastag_id: document.getElementById('fastagId').value,
        location_id: parseInt(document.getElementById('locationId').value),
        kyc_document_type: document.getElementById('kycType').value,
        kyc_document_number: document.getElementById('kycNumber').value,
        valid_from: document.getElementById('validFrom').value,
        valid_to: document.getElementById('validTo').value,
        is_active: document.getElementById('isActive').value === 'true',
        access_permissions: [
            {
                lane_id: parseInt(document.getElementById('permissionLaneId').value),
                start_time: document.getElementById('startTime').value,
                end_time: document.getElementById('endTime').value,
                days_of_week: document.getElementById('daysOfWeek').value
            }
        ]
    };

    fetch('/api/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('addUserResponse').textContent = JSON.stringify(data, null, 2);
    })
    .catch(error => {
        document.getElementById('addUserResponse').textContent = 'Error: ' + error.message;
    });
}

function testEditUser() {
    const userId = document.getElementById('editUserId').value;
    const data = {
        name: document.getElementById('editUserName').value,
        designation: document.getElementById('editUserDesignation').value,
        vehicle_number: document.getElementById('editVehicleNumber').value,
        location_id: parseInt(document.getElementById('editLocationId').value),
        is_active: document.getElementById('editIsActive').value === 'true'
    };

    fetch(`/api/users/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editUserResponse').textContent = JSON.stringify(data, null, 2);
    })
    .catch(error => {
        document.getElementById('editUserResponse').textContent = 'Error: ' + error.message;
    });
}
</script>
{% endblock %}