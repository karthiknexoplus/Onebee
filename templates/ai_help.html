{% extends "base.html" %}

{% block title %}AI Assistant{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>AI Assistant
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="settingsDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-cog"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="clearChat">
                                <i class="fas fa-trash me-2"></i>Clear Chat
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="exportChat">
                                <i class="fas fa-download me-2"></i>Export Chat
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div id="chat-container" class="mb-4" style="height: 400px; overflow-y: auto;">
                        <div class="chat-messages" id="chat-messages">
                            <div class="message system-message mb-3">
                                <div class="message-content p-3 rounded bg-light">
                                    <p class="mb-0">Hello! I'm your AI assistant. I can help you with questions about the Access Control System. What would you like to know?</p>
                                </div>
                            </div>
                        </div>
                        <div id="typing-indicator" class="message system-message mb-3" style="display: none;">
                            <div class="message-content p-3 rounded bg-light">
                                <div class="typing">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form id="chat-form" class="d-flex gap-2">
                        <input type="text" id="user-input" class="form-control" placeholder="Type your question here..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    display: flex;
    flex-direction: column;
}

.message {
    max-width: 80%;
}

.user-message {
    align-self: flex-end;
}

.system-message {
    align-self: flex-start;
}

.message-content {
    word-wrap: break-word;
}

.user-message .message-content {
    background-color: #007bff;
    color: white;
}

.system-message .message-content {
    background-color: #f8f9fa;
}

.typing {
    display: flex;
    align-items: center;
    gap: 4px;
}

.typing span {
    width: 8px;
    height: 8px;
    background: #6c757d;
    border-radius: 50%;
    animation: typing 1s infinite ease-in-out;
}

.typing span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

.suggested-questions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
}

.suggested-question {
    background-color: #e9ecef;
    border: none;
    border-radius: 16px;
    padding: 4px 12px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggested-question:hover {
    background-color: #dee2e6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatMessages = document.getElementById('chat-messages');
    const chatContainer = document.getElementById('chat-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const clearChatBtn = document.getElementById('clearChat');
    const exportChatBtn = document.getElementById('exportChat');

    const projectKnowledge = {
        "system_overview": {
            "what is this system": "This is an Access Control System that manages vehicle access through barriers. It includes features for user management, vehicle tracking, and barrier control.",
            "how does it work": "The system uses a combination of sensors, ANPR cameras, and barrier controllers to manage vehicle access. It verifies vehicle numbers against a database of authorized users and controls barriers accordingly.",
            "main features": "Key features include: 1) User Management, 2) Vehicle Presence Detection, 3) ANPR (Automatic Number Plate Recognition), 4) Barrier Control, 5) Access Logs, 6) Reports Generation, and 7) API Integration.",
            "system requirements": "The system requires: 1) Internet connectivity, 2) Power supply, 3) Network infrastructure, 4) Compatible hardware devices (sensors, cameras, barriers), and 5) Modern web browser for the interface."
        },
        "user_management": {
            "how to add user": "To add a user: 1) Go to Users section, 2) Click 'Add New User', 3) Fill in user details (name, vehicle number, Fastag ID), 4) Set access permissions, 5) Click 'Save'.",
            "user permissions": "User permissions include: 1) Access time windows, 2) Allowed lanes, 3) Days of access, 4) Vehicle restrictions, and 5) Location-based access.",
            "edit user": "To edit a user: 1) Go to Users section, 2) Find the user, 3) Click 'Edit', 4) Modify details, 5) Save changes.",
            "deactivate user": "To deactivate a user: 1) Go to Users section, 2) Find the user, 3) Click 'Edit', 4) Toggle 'Active' status, 5) Save changes."
        },
        "vehicle_tracking": {
            "vehicle presence": "Vehicle presence is detected using sensors and cameras. The system records: 1) Detection time, 2) Lane information, 3) Vehicle number (if ANPR successful), 4) Access status.",
            "anpr system": "The ANPR (Automatic Number Plate Recognition) system: 1) Captures vehicle images, 2) Processes number plates, 3) Matches against database, 4) Controls barrier access.",
            "tracking features": "Tracking features include: 1) Real-time presence detection, 2) Historical movement logs, 3) Access patterns, 4) Violation detection, 5) Custom alerts."
        },
        "barrier_control": {
            "control barrier": "To control barriers: 1) Use the API interface, 2) Send commands (open/close), 3) Monitor status, 4) View operation logs.",
            "barrier types": "Supported barrier types: 1) Automatic gates, 2) Boom barriers, 3) Sliding gates, 4) Swing gates.",
            "barrier status": "Barrier status includes: 1) Open/Closed state, 2) Operation mode, 3) Error conditions, 4) Maintenance status.",
            "barrier logs": "Barrier logs record: 1) Operation time, 2) Command source, 3) Success/failure, 4) Error messages."
        },
        "reports": {
            "available reports": "Available reports: 1) Daily activity, 2) User access logs, 3) Barrier operations, 4) System health, 5) Violation reports.",
            "generate report": "To generate reports: 1) Go to Reports section, 2) Select report type, 3) Set date range, 4) Choose format, 5) Generate.",
            "export reports": "Reports can be exported as: 1) PDF, 2) Excel, 3) CSV, 4) JSON formats.",
            "schedule reports": "To schedule reports: 1) Go to Reports, 2) Click 'Schedule', 3) Set frequency, 4) Choose recipients, 5) Save schedule."
        },
        "api_integration": {
            "api endpoints": "Main API endpoints: 1) /api/vehicle/presence, 2) /api/vehicle/anpr, 3) /api/barrier/control, 4) /api/health/check.",
            "api authentication": "API authentication uses: 1) API keys, 2) JWT tokens, 3) OAuth2 for third-party integration.",
            "api documentation": "API documentation is available at: 1) /api/docs for Swagger UI, 2) /api/test for testing interface.",
            "api examples": "API examples include: 1) Vehicle detection, 2) Barrier control, 3) Health checks, 4) User management."
        },
        "system_maintenance": {
            "health check": "System health checks monitor: 1) Device status, 2) Network connectivity, 3) Database health, 4) API availability.",
            "maintenance tasks": "Regular maintenance includes: 1) Database backups, 2) Log rotation, 3) Device calibration, 4) Software updates.",
            "troubleshooting": "Common troubleshooting steps: 1) Check device connectivity, 2) Verify network status, 3) Review error logs, 4) Test API endpoints.",
            "backup restore": "Backup and restore procedures: 1) Daily automated backups, 2) Manual backup option, 3) Point-in-time recovery, 4) Data export/import."
        }
    };

    const suggestedQuestions = {
        "system_overview": ["What is this system?", "How does it work?", "What are the main features?"],
        "user_management": ["How to add a user?", "How to set user permissions?", "How to edit user details?"],
        "vehicle_tracking": ["How does vehicle tracking work?", "What is ANPR?", "How to view vehicle logs?"],
        "barrier_control": ["How to control barriers?", "What are the barrier types?", "How to check barrier status?"],
        "reports": ["What reports are available?", "How to generate reports?", "How to export reports?"],
        "api_integration": ["What are the API endpoints?", "How to authenticate API?", "Where is the API documentation?"],
        "system_maintenance": ["How to check system health?", "What maintenance tasks are needed?", "How to troubleshoot issues?"]
    };

    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'system-message'} mb-3`;
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content p-3 rounded';
        messageContent.innerHTML = `<p class="mb-0">${content}</p>`;
        
        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);
        
        if (!isUser) {
            const category = findCategory(content);
            if (category && suggestedQuestions[category]) {
                const suggestedDiv = document.createElement('div');
                suggestedDiv.className = 'suggested-questions';
                suggestedQuestions[category].forEach(question => {
                    const button = document.createElement('button');
                    button.className = 'suggested-question';
                    button.textContent = question;
                    button.onclick = () => {
                        userInput.value = question;
                        chatForm.dispatchEvent(new Event('submit'));
                    };
                    suggestedDiv.appendChild(button);
                });
                messageDiv.appendChild(suggestedDiv);
            }
        }
        
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function findCategory(content) {
        for (const [category, questions] of Object.entries(projectKnowledge)) {
            for (const [question, answer] of Object.entries(questions)) {
                if (answer === content) {
                    return category;
                }
            }
        }
        return null;
    }

    function getAIResponse(userMessage) {
        const message = userMessage.toLowerCase();

        const questionPatterns = {
            "what is": "definition",
            "how to": "procedure",
            "how does": "explanation",
            "what are": "list",
            "can you": "capability",
            "tell me about": "overview",
            "explain": "explanation",
            "show me": "demonstration",
            "where is": "location",
            "when can": "timing",
            "why does": "reason",
            "is it possible": "capability"
        };

        const enhancedKnowledge = {
            "system_overview": {
                "definition": "This is an Access Control System that manages vehicle access through barriers. It's a comprehensive solution that combines hardware and software to control and monitor vehicle entry/exit points.",
                "capability": "The system can: 1) Detect vehicles automatically, 2) Recognize number plates, 3) Control barriers, 4) Manage user access, 5) Generate reports, and 6) Monitor system health.",
                "components": "The system consists of: 1) ANPR cameras for vehicle recognition, 2) Barrier controllers for access control, 3) Sensors for vehicle detection, 4) Management software, and 5) API for integration.",
                "benefits": "Key benefits include: 1) Automated access control, 2) Enhanced security, 3) Real-time monitoring, 4) Detailed reporting, 5) Easy integration, and 6) Scalable architecture."
            },
            "user_management": {
                "procedure": "To manage users: 1) Access the Users section, 2) Use 'Add New' for new users, 3) Fill in details (name, vehicle, Fastag ID), 4) Set permissions, 5) Save changes.",
                "capability": "You can: 1) Create new users, 2) Edit existing users, 3) Set access permissions, 4) Deactivate users, 5) View user history, and 6) Manage user groups.",
                "permissions": "Available permissions: 1) Time-based access, 2) Location-based access, 3) Vehicle restrictions, 4) Special access rights, and 5) Temporary access."
            },
            "vehicle_tracking": {
                "explanation": "Vehicle tracking works through: 1) ANPR cameras capture vehicle images, 2) Software processes number plates, 3) System matches against database, 4) Access is granted/denied, 5) Logs are maintained.",
                "features": "Tracking features include: 1) Real-time detection, 2) Historical logs, 3) Access patterns, 4) Violation alerts, 5) Custom reporting, and 6) Integration capabilities.",
                "capability": "The system can: 1) Detect vehicles automatically, 2) Recognize number plates, 3) Track movement history, 4) Generate alerts, and 5) Export tracking data."
            },
            "barrier_control": {
                "procedure": "To control barriers: 1) Use the API or interface, 2) Select the barrier, 3) Choose action (open/close), 4) Confirm command, 5) Monitor status.",
                "types": "Supported barriers: 1) Automatic gates, 2) Boom barriers, 3) Sliding gates, 4) Swing gates, 5) Custom solutions.",
                "capability": "Barrier control can: 1) Open/close automatically, 2) Monitor status, 3) Log operations, 4) Handle errors, and 5) Integrate with other systems."
            },
            "reports": {
                "types": "Available reports: 1) Daily activity, 2) User access, 3) Barrier operations, 4) System health, 5) Violation reports, 6) Custom reports.",
                "procedure": "To generate reports: 1) Go to Reports section, 2) Select type, 3) Set parameters, 4) Choose format, 5) Generate/export.",
                "capability": "You can: 1) Generate various reports, 2) Export in multiple formats, 3) Schedule reports, 4) Customize reports, and 5) Share reports."
            },
            "api_integration": {
                "endpoints": "Main endpoints: 1) /api/vehicle/presence, 2) /api/vehicle/anpr, 3) /api/barrier/control, 4) /api/health/check, 5) /api/users.",
                "capability": "The API can: 1) Control barriers, 2) Monitor vehicles, 3) Manage users, 4) Check system health, and 5) Generate reports.",
                "authentication": "Authentication methods: 1) API keys, 2) JWT tokens, 3) OAuth2, 4) Basic auth, 5) Custom auth."
            },
            "system_maintenance": {
                "procedure": "Maintenance steps: 1) Regular health checks, 2) Database backups, 3) Log rotation, 4) Device calibration, 5) Software updates.",
                "capability": "You can: 1) Monitor system health, 2) Perform backups, 3) Update software, 4) Calibrate devices, and 5) Troubleshoot issues.",
                "troubleshooting": "Common issues: 1) Device connectivity, 2) Network issues, 3) Database problems, 4) API errors, 5) Hardware failures."
            }
        };

        function findBestCategory(message) {
            const categoryScores = {};
            
            for (const [category, data] of Object.entries(enhancedKnowledge)) {
                let score = 0;
                const keywords = category.split('_');
                keywords.forEach(keyword => {
                    if (message.includes(keyword)) score += 2;
                });
                categoryScores[category] = score;
            }
            
            let bestCategory = null;
            let highestScore = 0;
            for (const [category, score] of Object.entries(categoryScores)) {
                if (score > highestScore) {
                    highestScore = score;
                    bestCategory = category;
                }
            }
            
            return bestCategory;
        }

        function getQuestionType(message) {
            for (const [pattern, type] of Object.entries(questionPatterns)) {
                if (message.includes(pattern)) return type;
            }
            return "general";
        }

        const category = findBestCategory(message);
        if (!category) {
            return `I'm not sure about that specific question. Here are some topics you can ask about:\n\n` +
                   Object.keys(enhancedKnowledge).map(cat => 
                       `- ${cat.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}`
                   ).join('\n') +
                   `\n\nYou can ask specific questions like:\n` +
                   `- "What is the system capable of?"\n` +
                   `- "How does vehicle tracking work?"\n` +
                   `- "What types of reports are available?"\n` +
                   `- "How to control barriers?"`;
        }

        const questionType = getQuestionType(message);
        
        const categoryData = enhancedKnowledge[category];
        if (categoryData[questionType]) {
            return categoryData[questionType];
        }

        return categoryData[Object.keys(categoryData)[0]];
    }

    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    function clearChat() {
        chatMessages.innerHTML = `
            <div class="message system-message mb-3">
                <div class="message-content p-3 rounded bg-light">
                    <p class="mb-0">Hello! I'm your AI assistant. I can help you with questions about the Access Control System. What would you like to know?</p>
                </div>
            </div>
        `;
    }

    function exportChat() {
        const messages = Array.from(chatMessages.children).map(msg => {
            const isUser = msg.classList.contains('user-message');
            const content = msg.querySelector('.message-content p').textContent;
            return `${isUser ? 'User' : 'Assistant'}: ${content}`;
        }).join('\n\n');

        const blob = new Blob([messages], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'chat-export.txt';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = userInput.value.trim();
        if (!message) return;
        
        addMessage(message, true);
        
        userInput.value = '';
        
        showTypingIndicator();
        
        setTimeout(() => {
            hideTypingIndicator();
            const response = getAIResponse(message);
            addMessage(response);
        }, 1000);
    });

    clearChatBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to clear the chat history?')) {
            clearChat();
        }
    });

    exportChatBtn.addEventListener('click', function(e) {
        e.preventDefault();
        exportChat();
    });
});
</script>
{% endblock %} 